name: Hire Dev Deployment to EC2

on:
  push:
    branches: [production]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 'lts/*'

      - name: Deploy to EC2 Instance (via SSH)
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          private_key: ${{ secrets.EC2_PRIVATE_KEY }} # Sá»­ dá»¥ng private key an toÃ n hÆ¡n password
          port: 22
          script: |
            echo "ğŸš€ Starting deployment to EC2 instance..."
            cd /root/CertX || { echo "âŒ Error: Could not navigate to the application directory."; exit 1; }
            echo "ğŸ”„ Fetching latest changes from origin/production..."
            git fetch origin production
            echo "âš ï¸ Resetting local repository to origin/production..."
            git reset --hard origin/production
            echo "ğŸ“¦ Installing dependencies..."
            yarn install --frozen-lockfile
            echo "ğŸ› ï¸ Building the application..."
            yarn build || { echo "âŒ Build failed. Please check the build logs for details."; exit 1; }

            echo "ğŸ›‘ Stopping the current PM2 process (certX)..."
            pm2 stop certX || echo "â„¹ï¸ PM2 process 'certX' not running."

            echo "ğŸ—‘ï¸ Removing the old .next build directory..."
            rm -rf .next

            echo "ğŸš€ Starting the application with PM2..."
            pm2 start yarn --name "certX" -- start -p 3000

            echo "ğŸ’¾ Saving the PM2 process list..."
            pm2 save

            echo "ğŸ‰ Deployment to EC2 instance completed successfully!"
